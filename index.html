<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Mukja – Cash‑Out (iPhone • Ultra • High Contrast)</title>
<style>
  :root{
    --bg:#f5f5f7; --surface:#ffffff; --ink:#0b0b0f; --muted:#374151; --line:#e5e7eb; --accent:#0a84ff;
    --red:#ef4444; --blue:#2563eb; --amber:#d97706; --green:#059669; --violet:#7c3aed;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b10; --surface:#14161a; --ink:#f3f4f6; --muted:#a1a1aa; --line:#26272b; --accent:#0a84ff;
      --red:#f87171; --blue:#60a5fa; --amber:#fbbf24; --green:#34d399; --violet:#a78bfa; }
  }
  *{box-sizing:border-box}
  body{ margin:0;background:var(--bg);color:var(--ink);
    font:17px/1.5 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; -webkit-tap-highlight-color:transparent; }
  .wrap{max-width:720px;margin-inline:auto;padding:14px; padding-bottom: calc(env(safe-area-inset-bottom,0) + 18px)}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
  h1{font-size:20px;margin:0;font-weight:900;letter-spacing:.2px}
  .sub{color:var(--muted);margin:4px 0 0 0;font-size:13px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.12); min-height:44px}
  .btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .step{font-weight:900;margin:0 0 10px 0;display:flex;align-items:center;gap:8px}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type="number"], input[type="date"], input[type="url"], input[type="text"], select{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:#000;accent-color:var(--accent); min-height:44px; font-size:17px;
  }
  select{appearance:none}
  @media (prefers-color-scheme: dark){
    input[type="number"], input[type="date"], input[type="url"], input[type="text"], select{ background:#0f1116;color:var(--ink);border-color:#2a2c31 }
  }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
  input[type=number]{ -moz-appearance:textfield }
  .row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;align-items:center;margin-bottom:10px}
  .seg{display:inline-flex;background:var(--bg);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{background:transparent;border:0;color:var(--muted);padding:8px 10px;font-weight:800;cursor:pointer; min-height:40px}
  .seg button.active{background:var(--surface);color:var(--ink)}
  .mono{font-variant-numeric:tabular-nums}
  .action{display:grid;grid-template-columns:10px 1fr auto;gap:12px;align-items:center;border-radius:14px;padding:12px;border:1px solid var(--line);background:var(--surface)}
  .barL{width:10px;height:100%;border-radius:8px}
  .action .title{font-size:17px;font-weight:900;margin:0}
  .action .amt{font-size:24px;font-weight:1000;display:flex;align-items:center;gap:8px;color:var(--ink)}
  .copy{font-size:13px;padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:transparent;cursor:pointer; min-height:36px}
  .bank .barL{background:var(--red)} .home .barL{background:var(--blue)} .safe .barL{background:var(--amber)} .ok .barL{background:var(--green)} .total .barL{background:var(--violet)}
  .kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .small{font-size:12px;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  .screenOnly{display:block}
  .printOnly{display:none}
  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:50}
  .panel{background:var(--surface);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -6px 20px rgba(0,0,0,.25);padding:12px 14px;max-height:85vh;overflow:auto;border:1px solid var(--line);width:100%;max-width:720px;margin:0 auto}
  .panel header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .close{background:transparent;border:1px solid var(--line);padding:6px 10px;border-radius:10px;font-weight:800;cursor:pointer}
  @media print{
    @page{size:auto; margin:0.5in}
    body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial}
    .wrap{max-width:none;padding:0}
    .screenOnly, .btn{display:none !important}
    .printOnly{display:block}
    .card{background:#fff;border-color:#ccc;box-shadow:none;page-break-inside:avoid}
    h1{font-size:18px}
    .kv{padding:6px 0}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header class="screenOnly">
      <div>
        <h1>Mukja – Cash‑Out</h1>
        
      </div>
      <div class="bar">
        <button class="btn" id="saveEntry">Save</button>
        <button class="btn secondary" id="btnPrint">Print</button>
        <button class="btn secondary" id="btnHistory">History</button>
        <button class="btn secondary" id="btnSettings">Settings</button>
      </div>
    </header>

    <section id="count" class="screenOnly">
      <div class="grid">
        <div class="card">
          <p class="step"><span class="dot"></span> Count & Cash‑Outs</p>
          <div class="row"><label>Date</label><input id="date" type="date"></div>
          <div class="row">
            <label>Staff</label>
            <select id="staff">
              <option selected>Lisa</option>
              <option>John</option>
              <option>Others</option>
            </select>
          </div>

          <div class="seg" role="tablist" aria-label="Bills mode">
            <button id="segDenom" class="active" role="tab" aria-selected="true">Denomination totals</button>
            <button id="segSingle" role="tab" aria-selected="false">Single bills total</button>
          </div>

          <div id="billsDenomBox" style="margin-top:8px">
            <div class="row"><label>Total in $100s</label><input id="amt100" type="number" step="100" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $50s</label><input id="amt50" type="number" step="50" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $20s</label><input id="amt20" type="number" step="20" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $10s</label><input id="amt10" type="number" step="10" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $5s</label><input id="amt5" type="number" step="5" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $1s</label><input id="amt1" type="number" step="1" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="kv"><span>Bills subtotal (denoms)</span><span class="mono" id="billsSub">$0.00</span></div>
          </div>

          <div id="billsSingleBox" style="display:none;margin-top:6px">
            <div class="row"><label>Bills total</label><input id="billsSingle" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
          </div>

          <div class="row" style="margin-top:4px"><label>Coins counted</label><input id="coins" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g., 1579 or 15.79"></div>
          <div class="row"><label>Other Cash‑Outs</label><input id="voids" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
          <div class="small">Net cash = Bills + Coins − Other Cash‑Outs. Till ends at $200 automatically.</div>

          <div id="posRow" class="row" style="display:none"><label>POS expected drawer (optional)</label><input id="posExpected" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
        </div>

        <div class="card">
          <p class="step"><span class="dot"></span> Do This (Automatic Plan)</p>

          <div id="actTotal" class="action total">
            <div class="barL"></div>
            <div><div class="title">TOTAL CASH TO TAKE OUT</div><div class="small">Deposit + Other Cash‑Outs</div></div>
            <div class="amt mono"><span id="totalOut">$0.00</span><button class="copy" data-copy="totalOut">Copy</button></div>
          </div>

          <div id="actBank" class="action bank" style="margin-top:8px">
            <div class="barL"></div>
            <div><div class="title">TAKE TO BANK (Deposit)</div><div class="small">Deposit (total)</div></div>
            <div class="amt mono"><span id="deposit">$0.00</span><button class="copy" data-copy="deposit">Copy</button></div>
          </div>

          <div id="actHome" class="action home" style="margin-top:8px">
            <div class="barL"></div>
            <div><div class="title">OTHER CASH‑OUTS</div><div class="small">Cash paid out today (payouts, petty cash)</div></div>
            <div class="amt mono"><span id="voidHome">$0.00</span><button class="copy" data-copy="voidHome">Copy</button></div>
          </div>

          <div id="actSafe" class="action safe" style="margin-top:8px; display:none">
            <div class="barL"></div>
            <div><div class="title">PULL FROM SAFE</div><div class="small">Add this to reach $200</div></div>
            <div class="amt mono"><span id="shortAmt">$0.00</span><button class="copy" data-copy="shortAmt">Copy</button></div>
          </div>

          <div id="actOk" class="action ok" style="margin-top:8px; display:none">
            <div class="barL"></div>
            <div><div class="title">Till Will End at $200</div><div class="small">No safe adjustment needed</div></div>
            <div class="amt mono"><span id="leave">$200.00</span></div>
          </div>

          <div class="kv" style="margin-top:8px"><span>Total counted cash</span><span class="mono" id="total">$0.00</span></div>
          <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="net">$0.00</span></div>
          <div class="kv"><span>Coins in bank deposit</span><span class="mono" id="depCoins">$0.00</span></div>
          <div class="kv"><span>Bills in bank deposit</span><span class="mono" id="depBills">$0.00</span></div>
          <div id="posKv" class="kv" style="display:none"><span>Over/Short vs POS expected</span><span class="mono" id="posDelta">$0.00</span></div>
        </div>
      </div>
    </section>

    <section id="printSummary" class="printOnly">
      <div class="card">
        <h1>Mukja — Cash‑Out</h1>
        <div class="kv"><span>Date</span><span class="mono" id="p_date"></span></div>
        <div class="kv"><span>Staff</span><span class="mono" id="p_staff"></span></div>
      </div>
      <div class="card">
        <div class="kv"><span>TAKE TO BANK (Deposit)</span><span class="mono" id="p_deposit">$0.00</span></div>
        <div class="kv"><span>OTHER CASH‑OUTS</span><span class="mono" id="p_other">$0.00</span></div>
        <div class="kv"><span>PULL FROM SAFE</span><span class="mono" id="p_short">$0.00</span></div>
        <div class="kv"><span>TOTAL CASH TO TAKE OUT</span><span class="mono" id="p_totalOut">$0.00</span></div>
      </div>
      <div class="card">
        <div class="kv"><span>Total counted cash</span><span class="mono" id="p_total">$0.00</span></div>
        <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="p_net">$0.00</span></div>
        <div class="kv"><span>Deposit: Bills</span><span class="mono" id="p_depBills">$0.00</span></div>
        <div class="kv"><span>Deposit: Coins</span><span class="mono" id="p_depCoins">$0.00</span></div>
        <div class="kv" id="p_posRow" style="display:none"><span>Over/Short vs POS expected</span><span class="mono" id="p_posDelta">$0.00</span></div>
      </div>
    </section>
  </div>

  <div class="sheet" id="sheetSettings" aria-hidden="true">
    <div class="panel">
      <header><div style="font-weight:900">Settings</div><button class="close" data-close="sheetSettings">Close</button></header>
      <div class="row"><label>Google Sheets Web App URL (Apps Script)</label><input id="sheetsUrl" type="url" placeholder="https://script.google.com/macros/s/…/exec"></div>
      <div class="row"><label>Secret token (optional, case‑sensitive)</label><input id="secret" type="text" placeholder="e.g., MUKJA-2025"></div>
      <div class="row"><label><input id="syncOnSave" type="checkbox" style="width:auto;margin-right:8px">Sync to Google Sheets on Save</label><div></div></div>
      <div class="row"><label><input id="autoBackup" type="checkbox" style="width:auto;margin-right:8px">Auto-download JSON backup after Save</label><div></div></div>
      <div class="row"><label><input id="showPOS" type="checkbox" style="width:auto;margin-right:8px">Show POS expected drawer field</label><div></div></div>
      <div><button class="btn secondary" id="btnTest">Test Sync</button></div>
    </div>
  </div>

  <div class="sheet" id="sheetHistory" aria-hidden="true">
    <div class="panel">
      <header><div style="font-weight:900">History</div><button class="close" data-close="sheetHistory">Close</button></header>
      <div class="bar" style="margin-bottom:8px">
        <button id="exportCsv" class="btn secondary">Export CSV</button>
        <button id="exportJson" class="btn secondary">Export JSON</button>
        <label class="btn secondary" for="importJson" style="cursor:pointer">Import JSON</label>
        <input id="importJson" type="file" accept="application/json" style="display:none">
        <button id="clear" class="btn secondary">Clear All</button>
      </div>
      <div class="small" style="margin-top:4px">Device‑local log. Export CSV/JSON to move or back up.</div>
      <div style="margin-top:10px;overflow:auto">
        <table id="tbl" style="width:100%;border-collapse:collapse;border:1px solid var(--line)">
          <thead>
            <tr style="background:#eef2ff;color:#0b0b0f">
              <th style="padding:8px;text-align:left">Date</th>
              <th style="padding:8px;text-align:left">Staff</th>
              <th style="padding:8px;text-align:left">Total</th>
              <th style="padding:8px;text-align:left">Net</th>
              <th style="padding:8px;text-align:left">Deposit</th>
              <th style="padding:8px;text-align:left">Other Cash‑Outs</th>
              <th style="padding:8px;text-align:left">Short from Safe</th>
              <th style="padding:8px;text-align:left">Total Out</th>
              <th style="padding:8px;text-align:left">Over/Short vs POS</th>
              <th style="padding:8px;text-align:left" class="small">Bills / Coins</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

<script>
  const $ = id => document.getElementById(id);
  const fmt = n => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(Number.isFinite(n)?Math.round(n*100)/100:0);
  const cfgKey='mukja_cfg_iphone_ultra', logKey='mukja_log_v1';
  const today = new Date(); const tz = new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('date').value = tz;
  $('btnPrint').addEventListener('click', () => { robustPrint(); });
  function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
  function v(id){ const el=$(id); const x=parseFloat(el?.value||''); return Number.isFinite(x)?Math.max(0,x):0; }
  const segDenom = $('segDenom'), segSingle = $('segSingle');
  const billsDenomBox = $('billsDenomBox'), billsSingleBox = $('billsSingleBox');
  function setMode(single=false){
    if(!single){ segDenom.classList.add('active'); segDenom.setAttribute('aria-selected','true');
      segSingle.classList.remove('active'); segSingle.setAttribute('aria-selected','false');
      billsDenomBox.style.display=''; billsSingleBox.style.display='none';
    } else { segDenom.classList.remove('active'); segDenom.setAttribute('aria-selected','false');
      segSingle.classList.add('active'); segSingle.setAttribute('aria-selected','true');
      billsDenomBox.style.display='none'; billsSingleBox.style.display=''; }
    compute();
  }
  segDenom.addEventListener('click', () => setMode(false));
  segSingle.addEventListener('click', () => setMode(true));

  const ids = ['amt100','amt50','amt20','amt10','amt5','amt1','billsSingle','coins','voids','posExpected','staff'];
  ids.forEach(i => $(i)?.addEventListener('input', (e) => {
    const x=parseFloat(e.target.value);
    if(e.target.type==='number' && Number.isFinite(x) && x<0){ e.target.value='0'; }
    compute();
  }));
  $('staff')?.addEventListener('change', compute);

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.copy'); if(!btn) return;
    const targetId = btn.getAttribute('data-copy'); const el = $(targetId);
    if(!el) return; const text = el.textContent.replace(/[^\d.-]/g,'');
    if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(text).then(()=> toast('Copied')).catch(()=>{});
    }
  });

  function billsValue(){ return (getComputedStyle(billsDenomBox).display!=='none')
    ? (v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1'))
    : v('billsSingle'); }

  function compute(){
    const bills = billsValue();
    $('billsSub').textContent = fmt(v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1'));
    const coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    let deposit=0, shortage=0; if(net>=FLOAT){ deposit=net-FLOAT; } else { shortage=FLOAT-net; }
    const coinLeave = Math.min(coins, Math.min(net, FLOAT));
    const coinSurplus = Math.max(coins-coinLeave, 0);
    const depCoins = Math.min(coinSurplus, deposit);
    const depBills = deposit - depCoins;
    const totalOut = deposit + other;
    $('total').textContent=fmt(total); $('net').textContent=fmt(net); $('voidHome').textContent=fmt(other);
    $('deposit').textContent=fmt(deposit); $('depCoins').textContent=fmt(depCoins); $('depBills').textContent=fmt(depBills);
    $('totalOut').textContent=fmt(totalOut);
    if(shortage>0){ $('actSafe').style.display='grid'; $('actOk').style.display='none'; $('shortAmt').textContent=fmt(shortage); }
    else { $('actSafe').style.display='none'; $('actOk').style.display='grid'; }
    const showPOS = getCfg().showPOS;
    $('posRow').style.display = showPOS ? '' : 'none';
    $('posKv').style.display = showPOS ? '' : 'none';
    if(showPOS){
      const posExp = v('posExpected'); const delta = net - posExp;
      $('posDelta').textContent = fmt(delta);
      $('posDelta').style.color = delta < 0 ? '#b91c1c' : (delta > 0 ? '#065f46' : 'inherit');
    }
  }
  compute();

  function collectEntry(){
    const bills = billsValue(), coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    const deposit=Math.max(net-FLOAT,0), shortage=Math.max(FLOAT-net,0);
    const coinLeave=Math.min(coins, Math.min(net,FLOAT)), coinSurplus=Math.max(coins-coinLeave,0);
    const depCoins=Math.min(coinSurplus, deposit), depBills=deposit-depCoins;
    const entry = { d: $('date').value, staff: $('staff').value, bills, coins, other, total, net, deposit, shortage, depCoins, depBills, totalOut: deposit+other, ts: Date.now() };
    const cfg=getCfg(); if(cfg.showPOS){ entry.posExpected=v('posExpected'); entry.posDelta=entry.net-entry.posExpected; }
    return entry;
  }

  function getCfg(){ try{ return JSON.parse(localStorage.getItem(cfgKey)||'{}'); }catch{return {};} }
  function setCfg(o){ localStorage.setItem(cfgKey, JSON.stringify(o)); }

  $('saveEntry').addEventListener('click', () => {
    const entry = collectEntry();
    const arr = JSON.parse(localStorage.getItem(logKey)||'[]'); arr.push(entry); localStorage.setItem(logKey, JSON.stringify(arr));
    const cfg=getCfg();
    if(cfg.autoBackup){
      const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`cashout_${entry.d}.json`; a.click(); URL.revokeObjectURL(url);
    }
    if(cfg.syncOnSave && cfg.sheetsUrl){
      const body={...entry, token: cfg.secret || ''};
      fetch(cfg.sheetsUrl, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}).then(()=>toast('Saved & sent')).catch(()=>toast('Saved (sync?)'));
    } else { toast('Saved'); }
  });

  $('btnPrint').addEventListener('click', () => { robustPrint(); });
  function fillPrintSummary(){
    const cfg = getCfg();
    const bills = billsValue(), coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    const deposit=Math.max(net-FLOAT,0), shortage=Math.max(FLOAT-net,0);
    const coinLeave=Math.min(coins, Math.min(net,FLOAT)), coinSurplus=Math.max(coins-coinLeave,0);
    const depCoins=Math.min(coinSurplus, deposit), depBills=deposit-depCoins;
    const totalOut = deposit + other;
    $('p_date').textContent = $('date').value;
    $('p_staff').textContent = $('staff').value;
    $('p_deposit').textContent = fmt(deposit);
    $('p_other').textContent = fmt(other);
    $('p_short').textContent = fmt(shortage);
    $('p_totalOut').textContent = fmt(totalOut);
    $('p_total').textContent = fmt(total);
    $('p_net').textContent = fmt(net);
    $('p_depBills').textContent = fmt(depBills);
    $('p_depCoins').textContent = fmt(depCoins);
    if(cfg.showPOS){
      const posExp = v('posExpected'); const delta = net - posExp;
      document.getElementById('p_posRow').style.display='flex';
      $('p_posDelta').textContent = fmt(delta);
    }else{
      document.getElementById('p_posRow').style.display='none';
    }
  }

  function openSheet(id){ const s=$(id); s.style.display='flex'; s.setAttribute('aria-hidden','false'); }
  function closeSheet(id){ const s=$(id); s.style.display='none'; s.setAttribute('aria-hidden','true'); }
  $('btnSettings').addEventListener('click', ()=>{ loadCfgToUI(); openSheet('sheetSettings'); });
  $('btnHistory').addEventListener('click', ()=>{ loadHistory(); openSheet('sheetHistory'); });
  document.addEventListener('click', (e)=>{ const c=e.target.closest('.close'); if(c){ closeSheet(c.getAttribute('data-close')); } });
  document.addEventListener('click', (e)=>{ const s=e.target.classList.contains('sheet')?e.target:null; if(s){ closeSheet(s.id); } });

  function loadCfgToUI(){
    const c=getCfg(); $('sheetsUrl').value=c.sheetsUrl||''; $('secret').value=c.secret||'';
    $('syncOnSave').checked=!!c.syncOnSave; $('autoBackup').checked=!!c.autoBackup; $('showPOS').checked=!!c.showPOS;
    compute();
  }
  $('showPOS')?.addEventListener('change', ()=>{ const o=getCfg(); o.showPOS=$('showPOS').checked; setCfg(o); compute(); });

  $('btnTest').addEventListener('click', async ()=>{
    const url=$('sheetsUrl').value.trim(); if(!url){ toast('Add your Web App URL first'); return; }
    try{ await fetch(url+'?ping=1', {method:'GET', mode:'no-cors'}); toast('Ping sent'); }catch{ toast('Ping failed'); }
  });

  function loadHistory(){
    const arr=JSON.parse(localStorage.getItem(logKey)||'[]'); arr.sort((a,b)=>b.ts-a.ts);
    const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
    for(const r of arr){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td style="padding:8px">${r.d||''}</td>
        <td style="padding:8px">${(r.staff||'')}</td>
        <td style="padding:8px" class="mono">${fmt(r.total||0)}</td>
        <td style="padding:8px" class="mono">${fmt(r.net||0)}</td>
        <td style="padding:8px" class="mono">${fmt(r.deposit||0)}</td>
        <td style="padding:8px" class="mono">${fmt(r.other||0)}</td>
        <td style="padding:8px" class="mono">${fmt(r.shortage||0)}</td>
        <td style="padding:8px" class="mono">${fmt(r.totalOut||0)}</td>
        <td style="padding:8px" class="mono">${r.posDelta!==undefined?fmt(r.posDelta):''}</td>
        <td style="padding:8px" class="small mono">Bills: ${fmt(r.depBills||0)} / Coins: ${fmt(r.depCoins||0)}</td>
      `;
      tb.appendChild(tr);
    }
  }
  function toCSV(){
    const arr=JSON.parse(localStorage.getItem(logKey)||'[]');
    const cols=['date','staff','total','net','deposit','other_cash_outs','short_from_safe','total_out','over_short_vs_pos','dep_bills','dep_coins','bills','coins','ts'];
    const rows=[cols.join(',')];
    for(const r of arr){
      rows.push([r.d, r.staff, r.total, r.net, r.deposit, r.other, r.shortage, r.totalOut, (r.posDelta!==undefined?r.posDelta:''), r.depBills, r.depCoins, r.bills, r.coins, r.ts].map(x=>x??'').join(','));
    }
    return rows.join('\n');
  }
  function download(name, text, mime){
    const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='exportCsv'){ download('cashout_history.csv', toCSV(), 'text/csv'); }
    if(e.target && e.target.id==='exportJson'){ const arr=JSON.parse(localStorage.getItem(logKey)||'[]'); download('cashout_history.json', JSON.stringify(arr,null,2), 'application/json'); }
  });
  document.getElementById('importJson').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const incoming=JSON.parse(r.result||'[]');
        const curr=JSON.parse(localStorage.getItem(logKey)||'[]');
        const seen=new Set(curr.map(x=>String(x.ts)));
        const merged=[...curr];
        for(const row of incoming){ const id=String(row.ts); if(!seen.has(id)){ merged.push(row); seen.add(id); } }
        localStorage.setItem(logKey, JSON.stringify(merged)); loadHistory(); alert('Import complete.');
      }catch(err){ alert('Bad JSON file.'); }
    };
    r.readAsText(file);
  });

  function quickPrint(){
    fillPrintSummary();
    try{
      const src = document.getElementById('printSummary').innerHTML;
      const css = `
        @page{size:auto; margin:0.5in}
        body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial;margin:0;padding:0}
        .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:14px;margin:10px 0;box-shadow:none}
        .kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #ccc}
        .kv:last-child{border-bottom:0}
        h1{font-size:18px;margin:0 0 6px 0}
        .mono{font-variant-numeric:tabular-nums}
      `;
      const w = window.open('', '_blank', 'noopener,noreferrer');
      if(!w){ window.print(); return; }
      w.document.open();
      w.document.write(`<!doctype html><html><head><meta charset=\"utf-8\"><title>Cash-Out</title><style>${css}</style></head><body>${src}</body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=>{ try{ w.print(); } finally { w.close(); } }, 150);
    }catch(e){
      window.print();
    }
  }


  // Denomination sanitizers: snap to valid multiples on blur
  const denomUnits = { amt100:100, amt50:50, amt20:20, amt10:10, amt5:5, amt1:1 };
  for (const [id,unit] of Object.entries(denomUnits)) {
    const el = document.getElementById(id);
    if(el){
      el.addEventListener('blur', () => {
        const raw = parseFloat(el.value||'');
        if(Number.isFinite(raw)){
          const fixed = Math.floor(raw / unit) * unit; // snap DOWN to multiple
          if(fixed !== raw){ el.value = String(fixed); }
        } else { el.value = ''; }
        compute();
      });
    }
  }
  // Coins: if user enters cents (no dot), convert to dollars on blur: 555 -> 5.55
  (function(){
    const el = document.getElementById('coins');
    if(!el) return;
    el.addEventListener('blur', () => {
      const s = (el.value||'').trim();
      if(!s) return;
      if(!s.includes('.')){
        const cents = parseInt(s,10);
        if(Number.isFinite(cents)){
          el.value = (cents/100).toFixed(2);
          compute();
        }
      } else {
        // normalize to two decimals
        const f = parseFloat(s);
        if(Number.isFinite(f)) el.value = (Math.round(f*100)/100).toFixed(2);
      }
    });
  })();

  // Robust print using hidden iframe (works better across Safari/Edge)
  function robustPrint(){
    fillPrintSummary();
    try{
      const src = document.getElementById('printSummary').innerHTML;
      const css = \`
        @page{size:auto; margin:0.5in}
        body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial;margin:0;padding:0}
        .card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:14px;margin:10px 0;box-shadow:none}
        .kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #ccc}
        .kv:last-child{border-bottom:0}
        h1{font-size:18px;margin:0 0 6px 0}
        .mono{font-variant-numeric:tabular-nums}
      \`;
      const ifr = document.createElement('iframe');
      ifr.style.position='fixed'; ifr.style.right='0'; ifr.style.bottom='0'; ifr.style.width='0'; ifr.style.height='0'; ifr.style.border='0';
      document.body.appendChild(ifr);
      const doc = ifr.contentWindow.document;
      doc.open();
      doc.write(\`<!doctype html><html><head><meta charset="utf-8"><title>Cash-Out</title><style>\${css}</style></head><body>\${src}</body></html>\`);
      doc.close();
      setTimeout(()=>{ ifr.contentWindow.focus(); ifr.contentWindow.print(); setTimeout(()=>document.body.removeChild(ifr), 500); }, 150);
    }catch(e){
      window.print();
    }
  }

</script>
</body>
</html>
