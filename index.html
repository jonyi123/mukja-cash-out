<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Mukja – Cash‑Out</title>
<style>
:root{
  --bg:#0b0b10; --surface:#14161a; --ink:#f3f4f6; --muted:#a1a1aa; --line:#26272b; --accent:#0a84ff;
  --red:#f87171; --blue:#60a5fa; --amber:#fbbf24; --green:#34d399; --violet:#a78bfa;
}
@media (prefers-color-scheme: light){
  :root{ --bg:#f5f5f7; --surface:#ffffff; --ink:#0b0b0f; --muted:#374151; --line:#e5e7eb; --accent:#0a84ff;
         --red:#ef4444; --blue:#2563eb; --amber:#d97706; --green:#059669; --violet:#7c3aed; }
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);
  font:17px/1.5 -apple-system,BlinkMacSystemFont,'SF Pro Text','SF Pro Display',system-ui,Segoe UI,Roboto,Helvetica,Arial;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent}
.wrap{max-width:720px;margin-inline:auto;padding:14px;padding-bottom:calc(env(safe-area-inset-bottom,0)+18px)}
h1{margin:0 0 10px 0;font-size:22px;font-weight:900}
header{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
.bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{appearance:none;background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.12);min-height:44px}
.btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
.card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);margin-bottom:12px}
.step{font-weight:900;margin:0 0 10px 0;display:flex;align-items:center;gap:8px}
.dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
label{display:block;font-weight:800;margin-bottom:6px}
input[type="number"], input[type="date"], select{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#0f1116;color:var(--ink);accent-color:var(--accent);min-height:44px;font-size:17px}
@media (prefers-color-scheme: light){input[type="number"],input[type="date"],select{background:#fff;color:#000;border-color:#e5e7eb}}
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 } input[type=number]{ -moz-appearance:textfield }
.row{display:grid;grid-template-columns:1.2fr 1fr;gap:10px;align-items:center;margin-bottom:10px}
.seg{display:inline-flex;background:var(--surface);border:1px solid var(--line);border-radius:12px;overflow:hidden;margin:4px 0 8px 0}
.seg button{background:transparent;border:0;color:var(--muted);padding:8px 10px;font-weight:900;cursor:pointer;min-height:40px}
.seg button.active{color:var(--ink);background:rgba(10,132,255,.12)}
.mono{font-variant-numeric:tabular-nums}
.action{display:grid;grid-template-columns:10px 1fr auto;gap:12px;align-items:center;border-radius:14px;padding:12px;border:1px solid var(--line);background:var(--surface);margin-top:8px}
.barL{width:10px;height:100%;border-radius:8px}
.action .title{font-size:17px;font-weight:900;margin:0}
.action .amt{font-size:24px;font-weight:1000;display:flex;align-items:center;gap:8px}
.bank .barL{background:var(--red)} .home .barL{background:var(--blue)} .safe .barL{background:var(--amber)} .ok .barL{background:var(--green)} .total .barL{background:var(--violet)}
.bank .amt{color:var(--red)} .home .amt{color:var(--blue)} .safe .amt{color:var(--amber)} .ok .amt{color:var(--green)} .total .amt{color:var(--violet)}
.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed var(--line)} .kv:last-child{border-bottom:0}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s}
.toast.show{opacity:1}
.screenOnly{display:block}.printOnly{display:none}
@media print{@page{size:auto;margin:0.5in}body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial}.wrap{max-width:none;padding:0}.screenOnly,.btn{display:none!important}.printOnly{display:block}.card{background:#fff;border-color:#ccc;box-shadow:none;page-break-inside:avoid}h1{font-size:18px}.kv{padding:6px 0}}
</style>
</head>
<body>
<div class="wrap">
  <header class="screenOnly">
    <div>
      <h1>Mukja — End‑of‑Day Cash‑Out</h1>
    </div>
    <div class="bar">
      <button class="btn" id="btnPrint">Print</button>
      <button class="btn secondary" id="btnClear">Clear</button>
      <button class="btn secondary" id="btnSettings">Settings</button>
    </div>
  </header>

  <section id="count" class="screenOnly">
    <div class="card">
      <p class="step"><span class="dot"></span> Count</p>
      <div class="row"><label>Date</label><input id="date" type="date" aria-label="Date"></div>
      <div class="row"><label>Staff</label><select id="staff"><option selected>Lisa</option><option>John</option><option>Others</option></select></div>

      <div class="seg" role="tablist" aria-label="Bills mode">
        <button id="segDenom" class="active" role="tab" aria-selected="true">Denomination totals</button>
        <button id="segSingle" role="tab" aria-selected="false">Single bills total</button>
      </div>

      <!-- Denomination mode -->
      <div id="billsDenomBox" style="display:block">
        <div class="row"><label>Total in $100s</label><input id="amt100" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 100s"></div>
        <div class="row"><label>Total in $50s</label><input id="amt50" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 50s"></div>
        <div class="row"><label>Total in $20s</label><input id="amt20" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 20s"></div>
        <div class="row"><label>Total in $10s</label><input id="amt10" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 10s"></div>
        <div class="row"><label>Total in $5s</label><input id="amt5" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 5s"></div>
        <div class="row"><label>Total in $1s</label><input id="amt1" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in 1s"></div>
        <div class="kv"><span>Bills subtotal (denoms)</span><span class="mono" id="billsSub">$0.00</span></div>
      </div>

      <!-- Single total mode -->
      <div id="billsSingleBox" style="display:none">
        <div class="row"><label>Bills total (whole dollars)</label><input id="billsSingle" type="number" inputmode="numeric" placeholder="0" aria-label="Total dollars in bills"></div>
      </div>

      <div class="row"><label>Coins counted</label><input id="coins" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g., 1579 or 15.79" aria-label="Coins counted"></div>
      <div class="row"><label>Other Cash‑Outs</label><input id="voids" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00" aria-label="Other Cash-Outs"></div>
      <div class="small">Net cash = Bills + Coins − Other Cash‑Outs. Till ends at $200 automatically.</div>

      <div id="posRow" class="row"><label>POS expected deposit (optional)</label><input id="posExpected" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"><div class="small" style="grid-column:1/-1">Enter Z report “Cash”</div></div>
    </div>

    <div class="card">
      <p class="step"><span class="dot"></span> Do This</p>

      <div id="actTotal" class="action total">
        <div class="barL"></div>
        <div><div class="title">TOTAL CASH TO TAKE OUT</div><div class="small">Deposit + Other Cash‑Outs</div></div>
        <div class="amt mono"><span id="totalOut">$0.00</span></div>
      </div>

      <div id="actBank" class="action bank">
        <div class="barL"></div>
        <div><div class="title">TAKE TO BANK (Deposit)</div><div class="small">Deposit (total)</div></div>
        <div class="amt mono"><span id="deposit">$0.00</span></div>
      </div>

      <div id="actHome" class="action home">
        <div class="barL"></div>
        <div><div class="title">OTHER CASH‑OUTS</div><div class="small">Cash paid out today (payouts, petty cash)</div></div>
        <div class="amt mono"><span id="voidHome">$0.00</span></div>
      </div>

      <div id="actSafe" class="action safe" style="display:none">
        <div class="barL"></div>
        <div><div class="title">PULL FROM SAFE</div><div class="small">Add this to reach $200</div></div>
        <div class="amt mono"><span id="shortAmt">$0.00</span></div>
      </div>

      <div id="actOk" class="action ok" style="display:none">
        <div class="barL"></div>
        <div><div class="title">Till Will End at $200</div><div class="small">No safe adjustment needed</div></div>
        <div class="amt mono"><span id="leave">$200.00</span></div>
      </div>

      <!-- Yellow‑sheet style math, straight down -->
      <div class="kv" style="margin-top:8px"><span>Total counted cash</span><span class="mono" id="total">$0.00</span></div>
      <div class="kv"><span>Less: Other Cash‑Outs</span><span class="mono" id="otherNeg">−$0.00</span></div>
      <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="net">$0.00</span></div>
      <div class="kv"><span>Less: Keep in till</span><span class="mono" id="floatNeg">−$200.00</span></div>
      <div class="kv"><span>Deposit (Take to bank)</span><span class="mono" id="depositLine">$0.00</span></div>
      <div class="kv"><span>Deposit: Bills</span><span class="mono" id="depBills">$0.00</span></div>
      <div class="kv"><span>Deposit: Coins</span><span class="mono" id="depCoins">$0.00</span></div>
      <div class="kv"><span>POS expected deposit</span><span class="mono" id="posExpectedLine">—</span></div>
      <div id="posKv" class="kv"><span>Over/Short vs POS expected deposit</span><span class="mono" id="posDelta">—</span></div>
    </div>
  </section>

  <!-- Save & History -->
  <div class="card screenOnly">
    <p class="step"><span class="dot"></span> Save & History</p>
    <div class="bar">
      <button class="btn secondary" id="btnSaveCSV">Save CSV</button>
      <button class="btn" id="btnSaveGitHub">Save to GitHub</button>
    </div>
    <div class="small">Downloads a CSV to your device. "Save to GitHub" appends to <span id="ghPathPreview">history/history.csv</span> on your repo (if configured in Settings).</div>
  </div>

  <!-- PRINT SUMMARY -->
  <section id="printSummary" class="printOnly">
    <div class="card">
      <h1>Mukja — Cash‑Out</h1>
      <div class="kv"><span>Date</span><span class="mono" id="p_date"></span></div>
      <div class="kv"><span>Staff</span><span class="mono" id="p_staff"></span></div>
      <div class="kv"><span>Counted by</span><span class="mono" id="p_counted"></span></div>
      <div class="kv"><span>Verified by</span><span class="mono">____________________</span></div>
    </div>
    <div class="card">
      <div class="kv"><span>TAKE TO BANK (Deposit)</span><span class="mono" id="p_deposit">$0.00</span></div>
      <div class="kv"><span>OTHER CASH‑OUTS</span><span class="mono" id="p_other">$0.00</span></div>
      <div class="kv"><span>PULL FROM SAFE</span><span class="mono" id="p_short">$0.00</span></div>
      <div class="kv"><span>TOTAL CASH TO TAKE OUT</span><span class="mono" id="p_totalOut">$0.00</span></div>
    </div>
    <div class="card">
      <div class="kv"><span>Total counted cash</span><span class="mono" id="p_total">$0.00</span></div>
      <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="p_net">$0.00</span></div>
      <div class="kv"><span>Deposit: Bills</span><span class="mono" id="p_depBills">$0.00</span></div>
      <div class="kv"><span>Deposit: Coins</span><span class="mono" id="p_depCoins">$0.00</span></div>
      <div class="kv" id="p_posRow" style="display:flex"><span>Over/Short vs POS expected deposit</span><span class="mono" id="p_posDelta">—</span></div>
    </div>
  </section>
</div>

<!-- SETTINGS SHEET -->
<div id="sheetSettings" style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;z-index:50">
  <div style="background:var(--surface);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -6px 20px rgba(0,0,0,.25);padding:12px 14px;max-height:85vh;overflow:auto;border:1px solid var(--line);width:100%;max-width:720px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:900">Settings</div>
      <button class="btn secondary" id="closeSettings">Close</button>
    </div>
    <div class="row"><label><input id="showPOS" type="checkbox" checked disabled style="width:auto;margin-right:8px">Show POS expected deposit row (always on)</label><div></div></div>
    <div class="row"><label>GitHub owner (username or org)</label><input id="ghOwner" placeholder="e.g., jonyi123"></div>
    <div class="row"><label>GitHub repo</label><input id="ghRepo" placeholder="e.g., mukja-cash-out"></div>
    <div class="row"><label>History file path</label><input id="ghPath" placeholder="history/history.csv"></div>
    <div class="row"><label>Branch</label><input id="ghBranch" placeholder="main"></div>
    <div class="row"><label>GitHub token (fine-grained, contents: read/write)</label><input id="ghToken" type="password" autocomplete="new-password" autocapitalize="off" spellcheck="false" placeholder="ghp_..."></div>
    <div class="bar"><button class="btn" id="saveGhCfg">Save settings</button></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const fmt=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number.isFinite(n)?Math.round(n*100)/100:0);
  const getCfg=()=>{try{return JSON.parse(localStorage.getItem('mukja_cfg_simple')||'{}');}catch{return{}}};
  const setCfg=o=>localStorage.setItem('mukja_cfg_simple',JSON.stringify(o));
  function toast(msg){const t=$('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);}

  function setToday(){
    const el=$('date'); const now=new Date();
    try{ el.valueAsDate=new Date(now.getFullYear(),now.getMonth(),now.getDate()); }catch(e){}
    if(!el.value){ const tz=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,10); el.value=tz; }
  }
  document.addEventListener('DOMContentLoaded', setToday);

  const segDenom=$('segDenom'), segSingle=$('segSingle'), boxDenom=$('billsDenomBox'), boxSingle=$('billsSingleBox');
  function setMode(single){
    if(single){ segSingle.classList.add('active'); segDenom.classList.remove('active'); boxSingle.style.display='block'; boxDenom.style.display='none'; }
    else{ segDenom.classList.add('active'); segSingle.classList.remove('active'); boxDenom.style.display='block'; boxSingle.style.display='none'; }
    compute();
  }
  segDenom.addEventListener('click',()=>setMode(false));
  segSingle.addEventListener('click',()=>setMode(true));

  function snapMultipleInt(val,unit){ if(!Number.isFinite(val)||val<0) return 0; val=Math.floor(val); return Math.floor(val/unit)*unit; }
  [['amt100',100],['amt50',50],['amt20',20],['amt10',10],['amt5',5]].forEach(([id,u])=>{
    const el=$(id); if(!el) return;
    const h=()=>{const raw=parseFloat(el.value); if(!Number.isFinite(raw)){el.value=''; compute(); return;} const snap=snapMultipleInt(raw,u); if(String(snap)!==el.value) el.value=String(snap); compute();};
    el.addEventListener('change',h); el.addEventListener('blur',h);
  });
  (function(){const el=$('amt1'); if(!el) return; const h=()=>{const raw=parseFloat(el.value); if(!Number.isFinite(raw)){el.value=''; compute(); return;} const snap=Math.max(0,Math.floor(raw)); if(String(snap)!==el.value) el.value=String(snap); compute();}; el.addEventListener('change',h); el.addEventListener('blur',h);})();
  (function(){const el=$('billsSingle'); if(!el) return; const h=()=>{const raw=parseFloat(el.value); if(!Number.isFinite(raw)){el.value=''; compute(); return;} const snap=Math.max(0,Math.floor(raw)); if(String(snap)!==el.value) el.value=String(snap); compute();}; el.addEventListener('change',h); el.addEventListener('blur',h);})();

  (function(){const el=$('coins'); if(!el) return; const normalize=()=>{const s=(el.value||'').trim(); if(!s) return; if(!s.includes('.')){const cents=parseInt(s,10); if(Number.isFinite(cents)) el.value=(cents/100).toFixed(2);} else {const f=parseFloat(s); if(Number.isFinite(f)) el.value=(Math.round(f*100)/100).toFixed(2);} compute();}; el.addEventListener('blur',normalize); el.addEventListener('change',normalize);})();
  (function(){const el=$('posExpected'); if(!el) return; const normalize=()=>{const s=(el.value||'').trim(); if(!s) return; if(/^\d+$/.test(s)&&s.length>2){el.value=(parseInt(s,10)/100).toFixed(2);} else {const f=parseFloat(s); if(Number.isFinite(f)) el.value=(Math.round(f*100)/100).toFixed(2);} compute();}; el.addEventListener('blur',normalize); el.addEventListener('change',normalize);})();

  $('showPOS').checked=true; $('showPOS').setAttribute('disabled','');
  $('showPOS').addEventListener('change',()=>{ $('showPOS').checked=true; });

  function setPosDeltaText(delta){
    const abs = Math.abs(Math.round(delta*100)/100);
    const signText = delta < 0 ? 'SHORT ' : (delta > 0 ? 'OVER ' : '');
    const formatted = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(abs);
    return signText ? (signText + formatted) : formatted;
  }

  function billsValue(){ return boxDenom.style.display!=='none' ? (v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1')) : v('billsSingle'); }
  function v(id){ const el=$(id); const x=parseFloat(el?.value||''); return Number.isFinite(x)?Math.max(0,x):0; }

  function compute(){
    const bills=billsValue();
    $('billsSub').textContent=fmt(v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1'));
    const coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    let deposit=0, shortage=0; if(net>=FLOAT){deposit=net-FLOAT;} else {shortage=FLOAT-net;}
    const coinLeave=Math.min(coins, Math.min(net,FLOAT));
    const coinSurplus=Math.max(coins-coinLeave,0);
    const depCoins=Math.min(coinSurplus, deposit);
    const depBills=deposit-depCoins;
    const totalOut=deposit+other;

    $('total').textContent=fmt(total);
    $('otherNeg').textContent='−'+fmt(other);
    $('net').textContent=fmt(net);
    $('floatNeg').textContent='−'+fmt(FLOAT);
    $('depositLine').textContent=fmt(deposit);
    $('voidHome').textContent=fmt(other);
    $('deposit').textContent=fmt(deposit);
    $('depCoins').textContent=fmt(depCoins);
    $('depBills').textContent=fmt(depBills);
    $('totalOut').textContent=fmt(totalOut);

    if(shortage>0){ $('actSafe').style.display='grid'; $('actOk').style.display='none'; $('shortAmt').textContent=fmt(shortage); }
    else { $('actSafe').style.display='none'; $('actOk').style.display='grid'; }

    const posStr = ($('posExpected')?.value || '').trim();
    const hasPos = posStr !== '' && !isNaN(parseFloat(posStr));
    $('posExpectedLine').textContent = hasPos ? fmt(v('posExpected')) : '—';
    if(hasPos){ const posExp=v('posExpected'); const delta=deposit-posExp; $('posDelta').textContent=setPosDeltaText(delta); $('posDelta').style.color=delta<0?'#f87171':(delta>0?'#34d399':'inherit'); }
    else { $('posDelta').textContent='—'; $('posDelta').style.color='inherit'; }

    $('p_date').textContent=$('date').value;
    $('p_staff').textContent=$('staff').value;
    $('p_counted').textContent=$('staff').value;
    $('p_deposit').textContent=fmt(deposit);
    $('p_other').textContent=fmt(other);
    $('p_short').textContent=fmt(shortage);
    $('p_totalOut').textContent=fmt(totalOut);
    $('p_total').textContent=fmt(total);
    $('p_net').textContent=fmt(net);
    $('p_depBills').textContent=fmt(depBills);
    $('p_depCoins').textContent=fmt(depCoins);
    $('p_posDelta').textContent = hasPos ? fmt(deposit - v('posExpected')) : '—';
  }

  ['amt100','amt50','amt20','amt10','amt5','amt1','billsSingle','coins','voids','posExpected','staff','date']
    .forEach(id=>$(id)?.addEventListener('input',compute));
  compute();

  function robustPrint(){
    try{
      const src=document.getElementById('printSummary').innerHTML;
      const css='@page{size:auto;margin:0.5in}body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial;margin:0;padding:0}.card{background:#fff;border:1px solid #ccc;border-radius:12px;padding:14px;margin:10px 0;box-shadow:none}.kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed #ccc}.kv:last-child{border-bottom:0}h1{font-size:18px;margin:0 0 6px 0}.mono{font-variant-numeric:tabular-nums}';
      const ifr=document.createElement('iframe'); ifr.style.position='fixed'; ifr.style.right='0'; ifr.style.bottom='0'; ifr.style.width='0'; ifr.style.height='0'; ifr.style.border='0';
      document.body.appendChild(ifr);
      const doc=ifr.contentWindow.document; doc.open(); doc.write(`<!doctype html><html><head><meta charset="utf-8"><title>Cash-Out</title><style>${css}</style></head><body>${src}</body></html>`); doc.close();
      setTimeout(()=>{ ifr.contentWindow.focus(); ifr.contentWindow.print(); setTimeout(()=>document.body.removeChild(ifr),500); }, 150);
    }catch(e){ window.print(); }
  }
  $('btnPrint').addEventListener('click', robustPrint);

  $('btnSettings').addEventListener('click',()=>{ document.getElementById('sheetSettings').style.display='flex'; });
  $('closeSettings').addEventListener('click',()=>{ document.getElementById('sheetSettings').style.display='none'; });

  function clearAll(){
    ['amt100','amt50','amt20','amt10','amt5','amt1','billsSingle','coins','voids','posExpected'].forEach(id=>{ const el=$(id); if(el){ el.value=''; } });
    setToday();
    compute();
  }
  $('btnClear').addEventListener('click', clearAll);

  const GH_KEY='mukja_github_cfg';
  function getGhCfg(){ try{const o=JSON.parse(localStorage.getItem(GH_KEY)||'{}'); return Object.assign({owner:'',repo:'',path:'history/history.csv',branch:'main',token:''},o);}catch{return{owner:'',repo:'',path:'history/history.csv',branch:'main',token:''}} }
  function setGhCfg(o){ localStorage.setItem(GH_KEY,JSON.stringify(o)); loadGhCfgUI(); }
  function loadGhCfgUI(){ const cfg=getGhCfg(); ['ghOwner','ghRepo','ghPath','ghBranch','ghToken'].forEach(id=>{ if($(id)) $(id).value = cfg[id.replace('gh','').toLowerCase()] || cfg[id] || ''; }); $('ghPathPreview')&&($('ghPathPreview').textContent=cfg.path||'history/history.csv'); }
  document.addEventListener('DOMContentLoaded', loadGhCfgUI);
  $('saveGhCfg')?.addEventListener('click',()=>{ const cfg={ owner:$('ghOwner')?.value.trim()||'', repo:$('ghRepo')?.value.trim()||'', path:$('ghPath')?.value.trim()||'history/history.csv', branch:$('ghBranch')?.value.trim()||'main', token:$('ghToken')?.value.trim()||'' }; setGhCfg(cfg); toast('GitHub settings saved'); });

  function toCSVRow(values){ return values.map(v=>{ if(v===null||v===undefined) return ''; const s=String(v); return (s.includes(',')||s.includes('"')||s.includes('\n')) ? ('"'+s.replace(/"/g,'""')+'"') : s; }).join(','); }
  function todayISO(){ const d = new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
  function collectRow(){ const header=['date','staff','$100s','$50s','$20s','$10s','$5s','$1s','bills_total','coins','other_cashouts','total_counted','net_after_cashouts','deposit','deposit_bills','deposit_coins','total_to_take_out','pos_expected_deposit','over_short']; const data={ date:$('date').value||todayISO(), staff:$('staff').value||'', amt100:v('amt100'),amt50:v('amt50'),amt20:v('amt20'),amt10:v('amt10'),amt5:v('amt5'),amt1:v('amt1'), bills:(document.getElementById('billsDenomBox').style.display!=='none')?(v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1')):v('billsSingle'), coins:v('coins'), other:v('voids'), total:parseFloat(($('total').textContent||'').replace(/[^\d.-]/g,''))||0, net:parseFloat(($('net').textContent||'').replace(/[^\d.-]/g,''))||0, deposit:parseFloat(($('deposit').textContent||'').replace(/[^\d.-]/g,''))||0, depBills:parseFloat(($('depBills').textContent||'').replace(/[^\d.-]/g,''))||0, depCoins:parseFloat(($('depCoins').textContent||'').replace(/[^\d.-]/g,''))||0, totalOut:parseFloat(($('totalOut').textContent||'').replace(/[^\d.-]/g,''))||0, posExpected:v('posExpected'), posDelta:(function(){ const t=$('posDelta')?.textContent||''; const m=t.match(/-?\d+(\.\d+)?/g); if(m) return parseFloat(m[m.length-1]); return 0;})() }; const row=[data.date,data.staff,data.amt100,data.amt50,data.amt20,data.amt10,data.amt5,data.amt1,data.bills,data.coins,data.other,data.total,data.net,data.deposit,data.depBills,data.depCoins,data.totalOut,data.posExpected,data.posDelta]; return {header,row}; }
  function downloadCSV(){ const {header,row}=collectRow(); const csv=toCSVRow(header)+'\n'+toCSVRow(row)+'\n'; const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); const date=(row[0]||todayISO()); const staff=(row[1]||'staff').replace(/\s+/g,'_'); a.download=`cashout_${date}_${staff}.csv`; a.href=URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href); toast('CSV downloaded'); }
  $('btnSaveCSV').addEventListener('click',downloadCSV);

  function b64encode(s){return btoa(unescape(encodeURIComponent(s)));}
  function b64decode(b64){return decodeURIComponent(escape(atob(b64)));}
  async function ghGet(o,r,p,b,t){const u=`https://api.github.com/repos/${o}/${r}/contents/${encodeURIComponent(p)}?ref=${encodeURIComponent(b)}`;return fetch(u,{headers:{'Authorization':`Bearer ${t}`,'Accept':'application/vnd.github+json'}})}
  async function ghPut(o,r,p,b,content,message,sha,t){const u=`https://api.github.com/repos/${o}/${r}/contents/${encodeURIComponent(p)}`;const body={message,content:b64encode(content),branch:b};if(sha) body.sha=sha;return fetch(u,{method:'PUT',headers:{'Authorization':`Bearer ${t}`,'Accept':'application/vnd.github+json'},body:JSON.stringify(body)})}
  async function saveToGitHub(){ const cfg=(function(){try{return JSON.parse(localStorage.getItem('mukja_github_cfg')||'{}')}catch{return{}}})(); const {owner='',repo='',path='history/history.csv',branch='main',token=''}=cfg; if(!owner||!repo||!path||!branch||!token){toast('Add GitHub settings in Settings');return;} const {header,row}=collectRow(); let content='', sha=null; let res=await ghGet(owner,repo,path,branch,token); if(res.status===200){const j=await res.json(); content=b64decode(j.content.replace(/\n/g,'')); sha=j.sha; if(!content.trim().length){content=toCSVRow(header)+'\n';} else if(!/^date,staff,/.test(content.split(/[\r\n]+/)[0])){content=toCSVRow(header)+'\n'+content.trim()+'\n';} else if(!content.endsWith('\n')){content+='\n';} content+=toCSVRow(row)+'\n'; } else if(res.status===404){ content=toCSVRow(header)+'\n'+toCSVRow(row)+'\n'; } else {toast('GitHub error (get): '+res.status); return;} const msg=`cashout: ${row[0]} by ${row[1]||'staff'}`; res=await ghPut(owner,repo,path,branch,content,msg,sha,token); if(res.status===201||res.status===200){toast('Saved to GitHub ✓');} else {toast('GitHub error (put): '+res.status);} }
  $('btnSaveGitHub').addEventListener('click',()=>{ saveToGitHub().catch(()=>toast('GitHub network error')); });

  try{ const saved=localStorage.getItem('mukja_staff'); if(saved&&$('staff')){$('staff').value=saved;} $('staff')?.addEventListener('change',()=>localStorage.setItem('mukja_staff',$('staff').value)); }catch(e){}
})();
</script>
</body>
</html>
