<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Mukja – Cash‑Out (iPhone • Mini)</title>
<style>
  :root{
    --bg:#f5f5f7; --surface:#ffffff; --ink:#0b0b0f; --muted:#6b7280; --line:#e5e7eb; --accent:#0a84ff;
    --softBlue:#e6f1ff; --softRed:#feecec; --softGreen:#eaf7ed; --softAmber:#fff6e1; --softViolet:#efeafe;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b10; --surface:#14161a; --ink:#e5e7eb; --muted:#a1a1aa; --line:#26272b; --accent:#0a84ff;
      --softBlue:#0f1d33; --softRed:#2a1414; --softGreen:#0f2517; --softAmber:#2a2212; --softViolet:#1a1630; }
  }
  *{box-sizing:border-box}
  body{ margin:0;background:var(--bg);color:var(--ink);
    font:17px/1.5 -apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display",system-ui,Segoe UI,Roboto,Helvetica,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; -webkit-tap-highlight-color:transparent; }
  .wrap{max-width:720px;margin-inline:auto;padding:14px; padding-bottom: calc(env(safe-area-inset-bottom,0) + 18px)}
  header{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
  h1{font-size:20px;margin:0;font-weight:900;letter-spacing:.2px}
  .sub{color:var(--muted);margin:4px 0 0 0;font-size:13px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;background:var(--accent);color:#fff;border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.12); min-height:44px}
  .btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted);background:transparent;font-weight:700}
  .tabs{display:flex;gap:6px;margin:6px 0 10px 0;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:var(--surface);cursor:pointer;min-height:40px}
  .tab[aria-selected="true"]{background:#e6f1ff;color:#0b0b0f;border-color:#b6d3ff}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .card{background:var(--surface);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .step{font-weight:900;margin:0 0 10px 0;display:flex;align-items:center;gap:8px}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--accent)}
  label{display:block;font-weight:700;margin-bottom:6px}
  input[type="number"], input[type="date"], input[type="url"], input[type="text"], select{
    width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--ink);accent-color:var(--accent); min-height:44px; font-size:17px;
  }
  select{appearance:none}
  @media (prefers-color-scheme: dark){
    input[type="number"], input[type="date"], input[type="url"], input[type="text"], select{ background:#0f1116;color:var(--ink);border-color:#2a2c31 }
  }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button{ -webkit-appearance:none;margin:0 }
  input[type=number]{ -moz-appearance:textfield }
  .row{display:grid;grid-template-columns:1.1fr 1fr;gap:10px;align-items:center;margin-bottom:10px}
  .seg{display:inline-flex;background:var(--bg);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{background:transparent;border:0;color:var(--muted);padding:8px 10px;font-weight:800;cursor:pointer; min-height:40px}
  .seg button.active{background:var(--surface);color:var(--ink)}
  .mono{font-variant-numeric:tabular-nums}
  .action{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;border-radius:14px;padding:12px;border:1px solid var(--line)}
  .action .title{font-size:16px;font-weight:900;margin:0}
  .action .amt{font-size:22px;font-weight:1000;display:flex;align-items:center;gap:8px}
  .copy{font-size:13px;padding:6px 8px;border-radius:10px;border:1px solid var(--line);background:transparent;cursor:pointer; min-height:36px}
  .bank{background:var(--softRed)} .home{background:var(--softBlue)} .safe{background:var(--softAmber)} .ok{background:var(--softGreen)} .total{background:var(--softViolet)}
  .kv{display:flex;justify-content:space-between;gap:8px;padding:6px 0;border-bottom:1px dashed var(--line)}
  .kv:last-child{border-bottom:0}
  .small{font-size:12px;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  .screenOnly{display:block}
  .printOnly{display:none}
  @media print{
    @page{size:auto; margin:0.5in}
    body{background:#fff;color:#000;font:12px/1.35 -apple-system,system-ui,Arial}
    .wrap{max-width:none;padding:0}
    .screenOnly, .tabs, nav, .btn, .seg, .chip{display:none !important}
    .printOnly{display:block}
    .card{background:#fff;border-color:#ccc;box-shadow:none;page-break-inside:avoid}
    h1{font-size:18px}
    .kv{padding:6px 0}
  }
  table{width:100%;border-collapse:collapse;background:var(--surface);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  thead th{background:#e6f1ff;color:#0b0b0f;padding:10px;text-align:left;font-weight:900}
  tbody td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
  tbody tr:last-child td{border-bottom:0}
</style>
</head>
<body>
  <div class="wrap">
    <header class="screenOnly">
      <div>
        <h1>Mukja – Cash‑Out</h1>
        <p class="sub">iPhone‑simple • Till auto‑locks at <strong>$200</strong>. Default: <span class="chip">Denomination totals</span>.</p>
      </div>
      <div class="bar">
        <button class="btn" id="saveEntry">Save</button>
        <button class="btn secondary" id="btnPrint">Print</button>
        <button class="btn secondary" id="btnSettings">Settings</button>
      </div>
    </header>

    <nav class="tabs screenOnly" role="tablist">
      <button class="tab" role="tab" id="tab-count" aria-selected="true" aria-controls="count">Count</button>
      <button class="tab" role="tab" id="tab-history" aria-selected="false" aria-controls="history">History</button>
      <button class="tab" role="tab" id="tab-settings" aria-selected="false" aria-controls="settings">Settings</button>
    </nav>

    <section id="count" aria-hidden="false" class="screenOnly">
      <div class="grid">

        <div class="card">
          <p class="step"><span class="dot"></span> Count & Cash‑Outs</p>
          <div class="row"><label>Date</label><input id="date" type="date"></div>
          <div class="row">
            <label>Staff</label>
            <select id="staff">
              <option selected>Lisa</option>
              <option>John</option>
              <option>Others</option>
            </select>
          </div>

          <div class="seg" role="tablist" aria-label="Bills mode">
            <button id="segDenom" class="active" role="tab" aria-selected="true">Denomination totals</button>
            <button id="segSingle" role="tab" aria-selected="false">Single bills total</button>
          </div>

          <div id="billsDenomBox" style="margin-top:8px">
            <div class="row"><label>Total in $100s</label><input id="amt100" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $50s</label><input id="amt50" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $20s</label><input id="amt20" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $10s</label><input id="amt10" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $5s</label><input id="amt5" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="row"><label>Total in $1s</label><input id="amt1" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
            <div class="kv"><span>Bills subtotal (denoms)</span><span class="mono" id="billsSub">$0.00</span></div>
          </div>

          <div id="billsSingleBox" style="display:none;margin-top:6px">
            <div class="row"><label>Bills total</label><input id="billsSingle" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
          </div>

          <div class="row" style="margin-top:4px"><label>Coins counted</label><input id="coins" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
          <div class="row"><label>Other Cash‑Outs</label><input id="voids" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
          <div class="small">Net cash = Bills + Coins − Other Cash‑Outs. Till ends at $200 automatically.</div>

          <div id="posRow" class="row" style="display:none"><label>POS expected drawer (optional)</label><input id="posExpected" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00"></div>
        </div>

        <div class="card">
          <p class="step"><span class="dot"></span> Do This (Automatic Plan)</p>

          <div id="actTotal" class="action total">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" width="28" height="28" aria-hidden="true"><path d="M4 7h16M4 12h16M4 17h16"></path></svg>
            <div><div class="title">TOTAL CASH TO TAKE OUT</div><div class="small">Deposit + Other Cash‑Outs</div></div>
            <div class="amt mono"><span id="totalOut">$0.00</span><button class="copy" data-copy="totalOut">Copy</button></div>
          </div>

          <div id="actBank" class="action bank" style="margin-top:8px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" width="28" height="28" aria-hidden="true"><path d="M3 10l9-6 9 6"></path><path d="M4 10h16v10H4z"></path><path d="M9 14h6v6H9z"></path></svg>
            <div><div class="title">TAKE TO BANK (Deposit)</div><div class="small">Deposit (total)</div></div>
            <div class="amt mono"><span id="deposit">$0.00</span><button class="copy" data-copy="deposit">Copy</button></div>
          </div>

          <div id="actHome" class="action home" style="margin-top:8px">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" width="28" height="28" aria-hidden="true"><path d="M3 11l9-7 9 7"></path><path d="M5 10v10h14V10"></path><path d="M9 20v-6h6v6"></path></svg>
            <div><div class="title">OTHER CASH‑OUTS</div><div class="small">Cash paid out today (payouts, petty cash)</div></div>
            <div class="amt mono"><span id="voidHome">$0.00</span><button class="copy" data-copy="voidHome">Copy</button></div>
          </div>

          <div id="actSafe" class="action safe" style="margin-top:8px; display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" width="28" height="28" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><rect x="3" y="5" width="18" height="14" rx="2"></rect></svg>
            <div><div class="title">PULL FROM SAFE</div><div class="small">Add this to reach $200</div></div>
            <div class="amt mono"><span id="shortAmt">$0.00</span><button class="copy" data-copy="shortAmt">Copy</button></div>
          </div>

          <div id="actOk" class="action ok" style="margin-top:8px; display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" width="28" height="28" aria-hidden="true"><path d="M20 6L9 17l-5-5"></path></svg>
            <div><div class="title">Till Will End at $200</div><div class="small">No safe adjustment needed</div></div>
            <div class="amt mono"><span id="leave">$200.00</span></div>
          </div>

          <div class="kv" style="margin-top:8px"><span>Total counted cash</span><span class="mono" id="total">$0.00</span></div>
          <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="net">$0.00</span></div>
          <div class="kv"><span>Coins in bank deposit</span><span class="mono" id="depCoins">$0.00</span></div>
          <div class="kv"><span>Bills in bank deposit</span><span class="mono" id="depBills">$0.00</span></div>
          <div id="posKv" class="kv" style="display:none"><span>Over/Short vs POS expected</span><span class="mono" id="posDelta">$0.00</span></div>
        </div>

      </div>
    </section>

    <section id="printSummary" class="printOnly">
      <div class="card">
        <h1>Mukja — Cash‑Out</h1>
        <div class="kv"><span>Date</span><span class="mono" id="p_date"></span></div>
        <div class="kv"><span>Staff</span><span class="mono" id="p_staff"></span></div>
      </div>
      <div class="card">
        <div class="kv"><span>TAKE TO BANK (Deposit)</span><span class="mono" id="p_deposit">$0.00</span></div>
        <div class="kv"><span>OTHER CASH‑OUTS</span><span class="mono" id="p_other">$0.00</span></div>
        <div class="kv"><span>PULL FROM SAFE</span><span class="mono" id="p_short">$0.00</span></div>
        <div class="kv"><span>TOTAL CASH TO TAKE OUT</span><span class="mono" id="p_totalOut">$0.00</span></div>
      </div>
      <div class="card">
        <div class="kv"><span>Total counted cash</span><span class="mono" id="p_total">$0.00</span></div>
        <div class="kv"><span>Net after cash‑outs</span><span class="mono" id="p_net">$0.00</span></div>
        <div class="kv"><span>Deposit: Bills</span><span class="mono" id="p_depBills">$0.00</span></div>
        <div class="kv"><span>Deposit: Coins</span><span class="mono" id="p_depCoins">$0.00</span></div>
        <div class="kv" id="p_posRow" style="display:none"><span>Over/Short vs POS expected</span><span class="mono" id="p_posDelta">$0.00</span></div>
      </div>
    </section>

    <section id="history" aria-hidden="true" class="screenOnly">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="font-weight:900;font-size:18px">History</div>
          <div class="bar">
            <button id="exportCsv" class="btn secondary">Export CSV</button>
            <button id="exportJson" class="btn secondary">Export JSON</button>
            <label class="btn secondary" for="importJson" style="cursor:pointer">Import JSON</label>
            <input id="importJson" type="file" accept="application/json" style="display:none">
            <button id="clear" class="btn secondary">Clear All</button>
          </div>
        </div>
        <div class="small" style="margin-top:4px">Device‑local log. Export CSV/JSON to move or back up.</div>
        <div style="margin-top:10px;overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>Date</th>
                <th>Staff</th>
                <th>Total</th>
                <th>Net</th>
                <th>Deposit</th>
                <th>Other Cash‑Outs</th>
                <th>Short from Safe</th>
                <th>Total Out</th>
                <th>Over/Short vs POS</th>
                <th class="small">Bills / Coins</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="settings" aria-hidden="true" class="screenOnly">
      <div class="card">
        <div style="font-weight:900;font-size:18px;margin-bottom:8px">Settings</div>
        <div class="row"><label>Google Sheets Web App URL (Apps Script)</label><input id="sheetsUrl" type="url" placeholder="https://script.google.com/macros/s/…/exec"></div>
        <div class="row"><label>Secret token (optional, case‑sensitive)</label><input id="secret" type="text" placeholder="e.g., MUKJA-2025"></div>
        <div class="row"><label><input id="syncOnSave" type="checkbox" style="width:auto;margin-right:8px">Sync to Google Sheets on Save</label><div></div></div>
        <div class="row"><label><input id="autoBackup" type="checkbox" style="width:auto;margin-right:8px">Auto-download JSON backup after Save</label><div></div></div>
        <div class="row"><label><input id="showPOS" type="checkbox" style="width:auto;margin-right:8px">Show POS expected drawer field</label><div></div></div>
        <div class="small">Tip: Add this page to Home Screen for a full‑screen feel.</div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved</div>

<script>
  const $ = id => document.getElementById(id);
  const fmt = n => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(Number.isFinite(n)?Math.round(n*100)/100:0);
  const cfgKey='mukja_cfg_iphone_mini', logKey='mukja_log_v1';
  const today = new Date(); const tz = new Date(today.getTime()-today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('date').value = tz;
  $('btnPrint').addEventListener('click', () => { fillPrintSummary(); window.print(); });
  function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
  function v(id){ const el=$(id); const x=parseFloat(el?.value||''); return Number.isFinite(x)?Math.max(0,x):0; }

  const sections = {count:$('count'), history:$('history'), settings:$('settings')};
  function showTab(name){
    for(const k in sections){ sections[k].setAttribute('aria-hidden', k===name ? 'false':'true'); }
    for(const b of document.querySelectorAll('.tab')){ b.setAttribute('aria-selected', b.id==='tab-'+name ? 'true':'false'); }
  }
  $('tab-count').addEventListener('click', ()=>showTab('count'));
  $('tab-history').addEventListener('click', ()=>{ loadHistory(); showTab('history'); });
  $('tab-settings').addEventListener('click', ()=>{ loadCfgToUI(); showTab('settings'); });

  const segDenom = $('segDenom'), segSingle = $('segSingle');
  const billsDenomBox = $('billsDenomBox'), billsSingleBox = $('billsSingleBox');
  function setMode(single=false){
    if(!single){ segDenom.classList.add('active'); segDenom.setAttribute('aria-selected','true');
      segSingle.classList.remove('active'); segSingle.setAttribute('aria-selected','false');
      billsDenomBox.style.display=''; billsSingleBox.style.display='none';
    } else { segDenom.classList.remove('active'); segDenom.setAttribute('aria-selected','false');
      segSingle.classList.add('active'); segSingle.setAttribute('aria-selected','true');
      billsDenomBox.style.display='none'; billsSingleBox.style.display=''; }
    compute();
  }
  segDenom.addEventListener('click', () => setMode(false));
  segSingle.addEventListener('click', () => setMode(true));

  const ids = ['amt100','amt50','amt20','amt10','amt5','amt1','billsSingle','coins','voids','posExpected'];
  ids.forEach(i => $(i)?.addEventListener('input', (e) => {
    const x=parseFloat(e.target.value);
    if(e.target.type==='number' && Number.isFinite(x) && x<0){ e.target.value='0'; }
    compute();
  }));

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.copy'); if(!btn) return;
    const targetId = btn.getAttribute('data-copy'); const el = $(targetId);
    if(!el) return; const text = el.textContent.replace(/[^\d.-]/g,'');
    if(navigator.clipboard?.writeText){
      navigator.clipboard.writeText(text).then(()=> toast('Copied'));
    }
  });

  function billsValue(){ return (getComputedStyle(billsDenomBox).display!=='none')
    ? (v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1'))
    : v('billsSingle'); }

  function compute(){
    const bills = billsValue();
    $('billsSub').textContent = fmt(v('amt100')+v('amt50')+v('amt20')+v('amt10')+v('amt5')+v('amt1'));
    const coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    let deposit=0, shortage=0; if(net>=FLOAT){ deposit=net-FLOAT; } else { shortage=FLOAT-net; }
    const coinLeave = Math.min(coins, Math.min(net, FLOAT));
    const coinSurplus = Math.max(coins-coinLeave, 0);
    const depCoins = Math.min(coinSurplus, deposit);
    const depBills = deposit - depCoins;
    const totalOut = deposit + other;
    $('total').textContent=fmt(total); $('net').textContent=fmt(net); $('voidHome').textContent=fmt(other);
    $('deposit').textContent=fmt(deposit); $('depCoins').textContent=fmt(depCoins); $('depBills').textContent=fmt(depBills);
    $('totalOut').textContent=fmt(totalOut);
    if(shortage>0){ $('actSafe').style.display='grid'; $('actOk').style.display='none'; $('shortAmt').textContent=fmt(shortage); }
    else { $('actSafe').style.display='none'; $('actOk').style.display='grid'; }
    const showPOS = getCfg().showPOS;
    $('posRow').style.display = showPOS ? '' : 'none';
    $('posKv').style.display = showPOS ? '' : 'none';
    if(showPOS){
      const posExp = v('posExpected'); const delta = net - posExp;
      $('posDelta').textContent = fmt(delta);
      $('posDelta').style.color = delta < 0 ? '#b91c1c' : (delta > 0 ? '#065f46' : 'inherit');
    }
  }
  compute();

  function collectEntry(){
    const bills = billsValue(), coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    const deposit=Math.max(net-FLOAT,0), shortage=Math.max(FLOAT-net,0);
    const coinLeave=Math.min(coins, Math.min(net,FLOAT)), coinSurplus=Math.max(coins-coinLeave,0);
    const depCoins=Math.min(coinSurplus, deposit), depBills=deposit-depCoins;
    const entry = { d: $('date').value, staff: $('staff').value, bills, coins, other, total, net, deposit, shortage, depCoins, depBills, totalOut: deposit+other, ts: Date.now() };
    const cfg=getCfg(); if(cfg.showPOS){ entry.posExpected=v('posExpected'); entry.posDelta=entry.net-entry.posExpected; }
    return entry;
  }

  function getCfg(){ try{ return JSON.parse(localStorage.getItem(cfgKey)||'{}'); }catch{return {};} }
  function setCfg(o){ localStorage.setItem(cfgKey, JSON.stringify(o)); }
  $('saveEntry').addEventListener('click', () => {
    const entry = collectEntry();
    const arr = JSON.parse(localStorage.getItem(logKey)||'[]'); arr.push(entry); localStorage.setItem(logKey, JSON.stringify(arr));
    const cfg=getCfg();
    if(cfg.autoBackup){
      const blob=new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`cashout_${entry.d}.json`; a.click(); URL.revokeObjectURL(url);
    }
    if(cfg.syncOnSave && cfg.sheetsUrl){
      const body={...entry, token: cfg.secret || ''};
      fetch(cfg.sheetsUrl, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)}).then(()=>toast('Saved & sent')).catch(()=>toast('Saved (sync?)'));
    } else { toast('Saved'); }
  });

  function loadHistory(){
    const arr=JSON.parse(localStorage.getItem(logKey)||'[]'); arr.sort((a,b)=>b.ts-a.ts);
    const tb=document.querySelector('#tbl tbody'); tb.innerHTML='';
    for(const r of arr){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.d||''}</td>
        <td>${(r.staff||'')}</td>
        <td class="mono">${fmt(r.total||0)}</td>
        <td class="mono">${fmt(r.net||0)}</td>
        <td class="mono">${fmt(r.deposit||0)}</td>
        <td class="mono">${fmt(r.other||0)}</td>
        <td class="mono">${fmt(r.shortage||0)}</td>
        <td class="mono">${fmt(r.totalOut||0)}</td>
        <td class="mono">${r.posDelta!==undefined?fmt(r.posDelta):''}</td>
        <td class="small mono">Bills: ${fmt(r.depBills||0)} / Coins: ${fmt(r.depCoins||0)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function toCSV(){
    const arr=JSON.parse(localStorage.getItem(logKey)||'[]');
    const cols=['date','staff','total','net','deposit','other_cash_outs','short_from_safe','total_out','over_short_vs_pos','dep_bills','dep_coins','bills','coins','ts'];
    const rows=[cols.join(',')];
    for(const r of arr){
      rows.push([r.d, r.staff, r.total, r.net, r.deposit, r.other, r.shortage, r.totalOut, (r.posDelta!==undefined?r.posDelta:''), r.depBills, r.depCoins, r.bills, r.coins, r.ts].map(x=>x??'').join(','));
    }
    return rows.join('\n');
  }
  function download(name, text, mime){
    const blob=new Blob([text],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
  }
  document.addEventListener('click', (e)=>{
    if(e.target && e.target.id==='exportCsv'){ download('cashout_history.csv', toCSV(), 'text/csv'); }
    if(e.target && e.target.id==='exportJson'){ const arr=JSON.parse(localStorage.getItem(logKey)||'[]'); download('cashout_history.json', JSON.stringify(arr,null,2), 'application/json'); }
  });
  $('importJson').addEventListener('change', (e)=>{
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const incoming=JSON.parse(r.result||'[]');
        const curr=JSON.parse(localStorage.getItem(logKey)||'[]');
        const seen=new Set(curr.map(x=>String(x.ts)));
        const merged=[...curr];
        for(const row of incoming){ const id=String(row.ts); if(!seen.has(id)){ merged.push(row); seen.add(id); } }
        localStorage.setItem(logKey, JSON.stringify(merged)); loadHistory(); alert('Import complete.');
      }catch(err){ alert('Bad JSON file.'); }
    };
    r.readAsText(file);
  });

  function fillPrintSummary(){
    const cfg = getCfg();
    const bills = billsValue(), coins=v('coins'), other=v('voids'), total=bills+coins, net=total-other, FLOAT=200;
    const deposit=Math.max(net-FLOAT,0), shortage=Math.max(FLOAT-net,0);
    const coinLeave=Math.min(coins, Math.min(net,FLOAT)), coinSurplus=Math.max(coins-coinLeave,0);
    const depCoins=Math.min(coinSurplus, deposit), depBills=deposit-depCoins;
    const totalOut = deposit + other;
    $('p_date').textContent = $('date').value;
    $('p_staff').textContent = $('staff').value;
    $('p_deposit').textContent = fmt(deposit);
    $('p_other').textContent = fmt(other);
    $('p_short').textContent = fmt(shortage);
    $('p_totalOut').textContent = fmt(totalOut);
    $('p_total').textContent = fmt(total);
    $('p_net').textContent = fmt(net);
    $('p_depBills').textContent = fmt(depBills);
    $('p_depCoins').textContent = fmt(depCoins);
    if(cfg.showPOS){
      const posExp = v('posExpected'); const delta = net - posExp;
      document.getElementById('p_posRow').style.display='flex';
      $('p_posDelta').textContent = fmt(delta);
    }else{
      document.getElementById('p_posRow').style.display='none';
    }
  }

  function loadCfgToUI(){
    const c=getCfg(); $('sheetsUrl').value=c.sheetsUrl||''; $('secret').value=c.secret||'';
    $('syncOnSave').checked=!!c.syncOnSave; $('autoBackup').checked=!!c.autoBackup; $('showPOS').checked=!!c.showPOS;
    compute();
  }
  $('btnSettings').addEventListener('click', ()=>{ loadCfgToUI(); showTab('settings'); });
  $('btnSaveCfg')?.addEventListener('click', ()=>{}); // placeholder

</script>
</body>
</html>
